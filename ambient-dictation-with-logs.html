<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ambient Dictation with Logging</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        textarea {
            width: 100%;
            height: 150px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 20px;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .secondary-button {
            background-color: #2196F3;
        }
        .secondary-button:hover {
            background-color: #1976D2;
        }
        .results {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }
        .success {
            color: #4CAF50;
            font-weight: bold;
        }
        .error {
            color: #f44336;
            font-weight: bold;
        }
        .info {
            color: #2196F3;
        }
        .log-summary {
            margin-top: 20px;
            padding: 15px;
            background-color: #e3f2fd;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .log-stats {
            display: flex;
            gap: 20px;
        }
        .stat {
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #1976D2;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Ambient Dictation â†’ AIGENTS Integration</h1>
        <p class="subtitle">With built-in logging and tracking</p>

        <label for="transcript">Enter Transcribed Text:</label>
        <textarea id="transcript" placeholder="Example: I'm seeing patient John Smith today. He was born on March 15th, 1985..."></textarea>

        <button onclick="processTranscript()">Process & Submit</button>
        <button onclick="showAmbientLogs()" class="secondary-button">View Logs</button>
        <button onclick="clearForm()">Clear</button>

        <div id="results" class="results" style="display:none;"></div>

        <div id="logSummary" class="log-summary">
            <div class="log-stats">
                <div class="stat">
                    <div class="stat-number" id="totalCount">0</div>
                    <div class="stat-label">Total Submissions</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="successCount">0</div>
                    <div class="stat-label">Successful</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="todayCount">0</div>
                    <div class="stat-label">Today</div>
                </div>
            </div>
            <button onclick="showAmbientLogs()" class="secondary-button">View All Logs</button>
        </div>
    </div>

    <script>
        // ============================================
        // COMPLETE AMBIENT DICTATION INTEGRATION CODE
        // ============================================

        // Configuration
        const AIGENTS_API_URL = "https://start-chain-run-943506065004.us-central1.run.app";

        // Simple logging system using localStorage
        const AmbientLogs = {
            getAll: function() {
                const logs = localStorage.getItem('ambient_dictation_logs');
                return logs ? JSON.parse(logs) : [];
            },
            
            add: function(logEntry) {
                const logs = this.getAll();
                logs.unshift({
                    ...logEntry,
                    id: Date.now(),
                    timestamp: new Date().toISOString()
                });
                if (logs.length > 50) logs.pop();
                localStorage.setItem('ambient_dictation_logs', JSON.stringify(logs));
                updateLogSummary(); // Update stats
            },
            
            clear: function() {
                localStorage.removeItem('ambient_dictation_logs');
                updateLogSummary();
            },
            
            getToday: function() {
                const today = new Date().toDateString();
                return this.getAll().filter(log => 
                    new Date(log.timestamp).toDateString() === today
                );
            },
            
            getSuccessful: function() {
                return this.getAll().filter(log => log.status === 'success');
            }
        };

        // Extract patient info
        function extractPatientInfo(text) {
            const info = {
                firstName: null,
                lastName: null,
                dob: null,
                sourceId: null
            };
            
            const namePatterns = [
                /patient (?:is |named? )?([A-Z][a-z]+)\s+([A-Z][a-z]+)/i,
                /treating ([A-Z][a-z]+)\s+([A-Z][a-z]+)/i,
                /(?:mr\.|mrs\.|ms\.|miss|doctor|dr\.) ([A-Z][a-z]+)\s+([A-Z][a-z]+)/i,
                /name is ([A-Z][a-z]+)\s+([A-Z][a-z]+)/i,
                /for ([A-Z][a-z]+)\s+([A-Z][a-z]+)/i,
                /patient ([A-Z][a-z]+)\s+([A-Z][a-z]+)/i
            ];
            
            for (const pattern of namePatterns) {
                const match = text.match(pattern);
                if (match) {
                    info.firstName = match[1];
                    info.lastName = match[2];
                    break;
                }
            }
            
            const dobPatterns = [
                /(?:born|dob|date of birth)[:\s]+(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/i,
                /(?:born|dob|date of birth)[:\s]+(\w+)\s+(\d{1,2})(?:st|nd|rd|th)?,?\s+(\d{4})/i,
                /(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/
            ];
            
            for (const pattern of dobPatterns) {
                const match = text.match(pattern);
                if (match) {
                    if (match[0].match(/\d{1,2}[\/\-]\d{1,2}[\/\-]\d{4}/)) {
                        info.dob = `${match[1].padStart(2,'0')}/${match[2].padStart(2,'0')}/${match[3]}`;
                    } else {
                        const months = ['january','february','march','april','may','june',
                                       'july','august','september','october','november','december'];
                        const monthNum = months.findIndex(m => match[1].toLowerCase().startsWith(m)) + 1;
                        if (monthNum > 0) {
                            info.dob = `${monthNum.toString().padStart(2,'0')}/${match[2].padStart(2,'0')}/${match[3]}`;
                        }
                    }
                    break;
                }
            }
            
            if (info.firstName && info.lastName && info.dob) {
                const dobFormatted = info.dob.replace(/\//g, '_');
                info.sourceId = `${info.lastName}_${info.firstName}__${dobFormatted}`;
            }
            
            return info;
        }

        // Main processing function
        async function processTranscript() {
            const transcriptText = document.getElementById('transcript').value.trim();
            if (!transcriptText) {
                showResult('Please enter some transcribed text', 'error');
                return;
            }

            const patientInfo = extractPatientInfo(transcriptText);
            
            if (!patientInfo.sourceId) {
                if (!patientInfo.firstName) {
                    patientInfo.firstName = prompt("Enter patient's first name:");
                    if (!patientInfo.firstName) return;
                }
                
                if (!patientInfo.lastName) {
                    patientInfo.lastName = prompt("Enter patient's last name:");
                    if (!patientInfo.lastName) return;
                }
                
                if (!patientInfo.dob) {
                    patientInfo.dob = prompt("Enter patient's date of birth (MM/DD/YYYY):");
                    if (!patientInfo.dob) return;
                }
                
                const dobFormatted = patientInfo.dob.replace(/\//g, '_');
                patientInfo.sourceId = `${patientInfo.lastName}_${patientInfo.firstName}__${dobFormatted}`;
            }

            showResult('Submitting to AIGENTS...', 'info');

            const chainName = "Screenshot_Patient_Creator";
            const requestData = {
                run_email: "jeffrey.Bander@providerloop.com",
                chain_to_run: chainName,
                human_readable_record: "Ambient dictation transcript from external app",
                source_id: patientInfo.sourceId,
                first_step_user_input: "",
                starting_variables: {
                    ambient_transcript: transcriptText,
                    transcription_source: "ambient_dictation_app",
                    patient_first_name: patientInfo.firstName,
                    patient_last_name: patientInfo.lastName,
                    patient_dob: patientInfo.dob,
                    ...(chainName !== "Screenshot_Patient_Creator" && {
                        Patient_ID: patientInfo.sourceId
                    }),
                    timestamp: new Date().toISOString(),
                    // Include specific patient variables only for Screenshot_Patient_Creator chain
                    ...(chainName === "Screenshot_Patient_Creator" && {
                        Patient_Address: patientInfo.address || '',
                        first_name: patientInfo.firstName || '',
                        last_name: patientInfo.lastName || '',
                        date_of_birth: patientInfo.dob || '',
                        Patient_Primary_Insurance: patientInfo.primaryInsurance || '',
                        Patient_Primary_Insurance_ID: patientInfo.primaryInsuranceId || '',
                        Patient_Secondary_Insurance: patientInfo.secondaryInsurance || '',
                        Patient_Secondary_Insurance_ID: patientInfo.secondaryInsuranceId || '',
                        Patient_Phone_Number: patientInfo.phone || '',
                        Patient_Email: patientInfo.email || ''
                    })
                }
            };

            try {
                const response = await fetch(AIGENTS_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    let chainRunId = result.ChainRun_ID || null;
                    
                    if (!chainRunId && result.responses && result.responses[0] && result.responses[0].rows) {
                        const firstRow = result.responses[0].rows[0];
                        chainRunId = firstRow["Run_ID"] || firstRow["_RowNumber"] || firstRow["ID"] || 
                                     firstRow["Run_Auto_Key"] || firstRow["Chain_Run_Key"] || firstRow.id;
                    }
                    
                    const viewUrl = `https://aigents-realtime-logs-943506065004.us-central1.run.app/?chainRunId=${chainRunId}`;
                    
                    AmbientLogs.add({
                        status: 'success',
                        patientName: `${patientInfo.firstName} ${patientInfo.lastName}`,
                        sourceId: patientInfo.sourceId,
                        chainName: chainName,
                        chainRunId: chainRunId,
                        viewUrl: viewUrl,
                        transcript: transcriptText.substring(0, 200) + '...'
                    });
                    
                    let html = '<h3 class="success">âœ“ Success!</h3>';
                    html += `<p><strong>Patient:</strong> ${patientInfo.firstName} ${patientInfo.lastName}</p>`;
                    html += `<p><strong>Source ID:</strong> ${patientInfo.sourceId}</p>`;
                    html += `<p><strong>Chain Run ID:</strong> ${chainRunId}</p>`;
                    html += `<p><a href="${viewUrl}" target="_blank">View in AIGENTS â†’</a></p>`;
                    showResult(html, 'success');
                } else {
                    throw new Error(result.error || result.message || 'Failed to trigger chain');
                }
            } catch (error) {
                AmbientLogs.add({
                    status: 'error',
                    patientName: `${patientInfo.firstName} ${patientInfo.lastName}`,
                    sourceId: patientInfo.sourceId,
                    chainName: chainName,
                    error: error.message,
                    transcript: transcriptText.substring(0, 200) + '...'
                });
                
                showResult(`Error: ${error.message}`, 'error');
            }
        }

        // Display logs function
        function showAmbientLogs() {
            const logs = AmbientLogs.getAll();
            
            let logContainer = document.getElementById('ambient-logs-container');
            if (!logContainer) {
                logContainer = document.createElement('div');
                logContainer.id = 'ambient-logs-container';
                logContainer.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    width: 400px;
                    max-height: 500px;
                    background: white;
                    border: 1px solid #ccc;
                    border-radius: 8px;
                    padding: 15px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                    overflow-y: auto;
                    z-index: 1000;
                `;
                document.body.appendChild(logContainer);
            }
            
            let html = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3 style="margin: 0;">Ambient Dictation Logs</h3>
                    <div>
                        <button onclick="AmbientLogs.clear(); showAmbientLogs();" style="padding: 5px 10px; margin-right: 5px;">Clear</button>
                        <button onclick="document.getElementById('ambient-logs-container').remove();" style="padding: 5px 10px;">Close</button>
                    </div>
                </div>
                <div style="max-height: 400px; overflow-y: auto;">
            `;
            
            if (logs.length === 0) {
                html += '<p style="color: #666;">No logs yet</p>';
            } else {
                logs.forEach(log => {
                    const date = new Date(log.timestamp).toLocaleString();
                    const statusColor = log.status === 'success' ? '#4CAF50' : '#f44336';
                    
                    html += `
                        <div style="border-bottom: 1px solid #eee; padding: 10px 0;">
                            <div style="display: flex; justify-content: space-between;">
                                <strong style="color: ${statusColor};">${log.status === 'success' ? 'âœ“' : 'âœ—'} ${log.patientName}</strong>
                                <small style="color: #666;">${date}</small>
                            </div>
                            <div style="font-size: 14px; color: #333;">Source ID: ${log.sourceId}</div>
                    `;
                    
                    if (log.status === 'success') {
                        html += `
                            <div style="font-size: 14px; color: #666;">Chain: ${log.chainName}</div>
                            <div style="font-size: 14px; color: #666;">Run ID: ${log.chainRunId}</div>
                            <a href="${log.viewUrl}" target="_blank" style="font-size: 14px;">View in AIGENTS â†’</a>
                        `;
                    } else {
                        html += `<div style="font-size: 14px; color: #f44336;">Error: ${log.error}</div>`;
                    }
                    
                    html += '</div>';
                });
            }
            
            html += '</div>';
            logContainer.innerHTML = html;
        }

        // UI Helper functions
        function showResult(message, type) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = message;
            resultsDiv.className = `results ${type}`;
        }

        function clearForm() {
            document.getElementById('transcript').value = '';
            document.getElementById('results').style.display = 'none';
        }

        function updateLogSummary() {
            const logs = AmbientLogs.getAll();
            const successLogs = AmbientLogs.getSuccessful();
            const todayLogs = AmbientLogs.getToday();
            
            document.getElementById('totalCount').textContent = logs.length;
            document.getElementById('successCount').textContent = successLogs.length;
            document.getElementById('todayCount').textContent = todayLogs.length;
        }

        // Initialize on page load
        updateLogSummary();
    </script>
</body>
</html>